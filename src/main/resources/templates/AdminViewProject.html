<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Admin View Projects - Gajmor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Icons -->
    <link rel="icon" href="Images/GajmorLogo.png">
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/linearicons.css">
    <link rel="stylesheet" href="/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/bootstrap.css">
    <link rel="stylesheet" href="/css/owl.carousel.css">
    <link rel="stylesheet" href="/css/magnific-popup.css">
    <link rel="stylesheet" href="/css/nice-select.css">
    <link rel="stylesheet" th:href="@{/css/main.css}">

    <script>
        // Protect admin page
        if (sessionStorage.getItem("isAdminLoggedIn") !== "true") {
            window.location.href = "/login";
        }
    </script>


    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0"></script>

    <style>

        body {
            margin:0;
            padding:0;
            background:#0d0d0d;
            color:white;
            font-family:"Montserrat",sans-serif;
            padding-top:120px;
        }

        .page-title {
            text-align:center;
            font-size:32px;
            color:#ffae00;
            font-weight:700;
            margin-bottom:25px;
            animation:fadeDown .5s ease;
        }
        @keyframes fadeDown {
            from { opacity:0; transform:translateY(-20px); }
            to { opacity:1; transform:translateY(0); }
        }

        .project-grid {
            display:grid;
            grid-template-columns:repeat(auto-fill,minmax(290px,1fr));
            gap:22px;
            padding:20px;
            width:90%;
            margin:auto;
            animation:fadeIn .6s ease;
        }

        @keyframes fadeIn {
            from { opacity:0; }
            to { opacity:1; }
        }

        .project-card {
            background:rgba(255,255,255,0.05);
            border:1px solid rgba(255,255,255,0.12);
            backdrop-filter:blur(8px);
            border-radius:18px;
            overflow:hidden;
            box-shadow:0 4px 20px rgba(0,0,0,0.35);
            transition:.35s ease;
            animation:fadeUp .5s ease;
        }

        @keyframes fadeUp {
            from { opacity:0; transform:translateY(20px); }
            to { opacity:1; transform:translateY(0); }
        }

        .project-card:hover {
            transform:scale(1.04);
            border-color:#ffae00;
            box-shadow:0 0 25px rgba(255,174,0,0.45);
        }

        .project-card img {
            width:100%;
            height:190px;
            object-fit:cover;
        }

        .project-title {
            text-align:center;
            padding:12px;
            font-weight:700;
            font-size:18px;
            color:white;
        }

        .card-actions {
            padding:12px;
            display:flex;
            justify-content:space-between;
        }

        .btn {
            border:none;
            padding:8px 14px;
            border-radius:10px;
            cursor:pointer;
            font-weight:600;
            transition:.3s ease;
            font-size:14px;
        }

        .view-btn { background:#ffae00; color:black; }
        .edit-btn { background:#3498db; color:white; }
        .delete-btn { background:#e74c3c; color:white; }

        .delete-btn:hover { background:#c0392b; }
        .edit-btn:hover { background:#227cbf; }
        .view-btn:hover { filter:brightness(1.1); }

        .modal {
            position:fixed;
            inset:0;
            background:rgba(0,0,0,0.7);
            display:none;
            justify-content:center;
            align-items:center;
            z-index:2000;
            backdrop-filter:blur(8px);
        }

        .modal-content {
            background:#111;
            border:1px solid rgba(255,255,255,0.15);
            padding:25px;
            width:95%;
            max-width:900px;
            max-height:90vh;
            overflow-y:auto;
            border-radius:16px;
            animation:pop .4s ease;
        }

        @keyframes pop {
            from { opacity:0; transform:scale(.85); }
            to { opacity:1; transform:scale(1); }
        }

        .close-btn {
            background:#ff3b3b;
            color:white;
            border:none;
            padding:8px 16px;
            float:right;
            border-radius:8px;
            cursor:pointer;
            font-weight:600;
        }

        .image-preview img {
            height:150px;
            border-radius:12px;
        }

        .image-box { position:relative; }

        .image-box button {
            position:absolute;
            top:8px;
            right:8px;
            background:#e74c3c;
            color:white;
            border:none;
            border-radius:50%;
            width:25px;
            height:25px;
        }

        input, textarea {
            width:100%;
            padding:12px;
            margin-bottom:12px;
            border-radius:10px;
            border:none;
            background:#1d1d1d;
            color:white;
        }

        textarea { height:130px; resize:none; }

        label { color:#ffae00; font-weight:600; }

    </style>

</head>

<body>

<!-- HEADER -->
<header class="default-header">
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand"><h1 style="color:white;">Gajmor</h1></a>
            <button class="navbar-toggler"><span class="fa fa-bars"></span></button>
            <div class="collapse navbar-collapse justify-content-end align-items-center">
                <ul class="navbar-nav">
                    <li><a href="/">Home</a></li>
                    <li><a href="/aboutUs">About</a></li>
                    <li><a href="/services">Services</a></li>
                    <li><a href="/view-pro">Projects</a></li>
                    <li><a href="/viewBlogs">Blog</a></li>
                    <li><a href="/jobs">careers</a></li>
                    <li><a href="/enquiry">Contact</a></li>
                </ul>
            </div>
        </div>
    </nav>
</header>

<h1 class="page-title">Admin View Projects</h1>

<!-- GRID -->
<div class="project-grid" id="projectGrid"></div>

<!-- VIEW MODAL -->
<div class="modal" id="viewModal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('viewModal')">Close</button>

        <h2 id="viewTitle"></h2>
        <div id="viewImages" class="image-preview"></div>

        <p><strong>Location:</strong> <span id="viewLocation"></span></p>
        <p><strong>Area:</strong> <span id="viewArea"></span></p>
        <p><strong>Description:</strong> <span id="viewDescription"></span></p>

        <button class="edit-btn" onclick="switchToEdit()">Edit This Project</button>
    </div>
</div>

<!-- EDIT MODAL -->
<div class="modal" id="editModal">
    <div class="modal-content">

        <button class="close-btn" onclick="closeModal('editModal')">Close</button>

        <h2>Edit Project</h2>

        <form id="editProjectForm">

            <input type="hidden" id="projectId">

            <label>Project Name</label>
            <input type="text" id="projectName">

            <label>Project Type</label>
            <input type="text" id="projectType">

            <label>Location</label>
            <input type="text" id="projectLocation">

            <label>Area</label>
            <input type="text" id="projectArea">

            <label>Description</label>
            <textarea id="projectDescription"></textarea>

            <label>Existing Images</label>
            <div id="editImages" class="image-preview"></div>

            <label>Add More Images</label>
            <input type="file" id="newImages" multiple>

            <button type="button" onclick="saveProject()" class="view-btn" style="width:100%; margin-top:15px;">
                Save Changes
            </button>
        </form>
    </div>
</div>

<script>

    /* SOFT SUCCESS SOUND */
    const successSound = new Audio("https://actions.google.com/sounds/v1/cartoon/pop.ogg");
    successSound.volume = 0.7;

    /* CONFETTI */
    function fireConfetti() {
        confetti({
            particleCount:150,
            spread:70,
            origin:{ y:0.6 }
        });
    }

    /* PREMIUM SUCCESS POPUP */
    function premiumSuccess(msg) {
        successSound.play();
        fireConfetti();

        Swal.fire({
            title: "Success!",
            html: `<b>${msg}</b>`,
            icon: "success",
            background: "#111",
            color: "white",
            showConfirmButton: false,
            timer: 1800,
            customClass: {
                popup: "animate__animated animate__slideInDown"
            }
        });
    }

    /* DELETE CONFIRM POPUP */
    function premiumDelete(msg) {
        successSound.play();

        Swal.fire({
            title: "Deleted!",
            html: `<b>${msg}</b>`,
            icon: "error",
            background: "#1a0000",
            color: "white",
            showConfirmButton: false,
            timer: 1500
        });
    }

    /* LOAD PROJECTS */
    fetch('/projects/list')
        .then(res => res.json())
        .then(projects => {
            const grid = document.getElementById('projectGrid');

            projects.forEach(project => {
                let card = document.createElement('div');
                card.classList.add('project-card');

                const firstImage = project.images.length > 0
                    ? `/uploads/${project.images[0].imagePath}`
                    : 'https://via.placeholder.com/400x250?text=No+Image';

                card.innerHTML = `
                    <img src="${firstImage}">
                    <div class="project-title">${project.name}</div>
                    <div class="card-actions">
                        <button class="btn view-btn" onclick='openViewModal(${JSON.stringify(project)})'>View</button>
                        <button class="btn edit-btn" onclick='openEditModal(${JSON.stringify(project)})'>Edit</button>
                        <button class="btn delete-btn" onclick="deleteProject(${project.id})">Delete</button>
                    </div>
                `;

                grid.appendChild(card);
            });
        });

    /* OPEN VIEW */
    let currentProject = null;

    function openViewModal(project) {
        currentProject = project;

        document.getElementById('viewTitle').textContent = project.name;
        document.getElementById('viewLocation').textContent = project.location;
        document.getElementById('viewArea').textContent = project.area;
        document.getElementById('viewDescription').textContent = project.description;

        document.getElementById('viewImages').innerHTML =
            project.images.map(img => `<img src="/uploads/${img.imagePath}">`).join('');

        document.getElementById('viewModal').style.display = 'flex';
    }

    function switchToEdit() {
        closeModal("viewModal");
        openEditModal(currentProject);
    }

    /* OPEN EDIT */
    function openEditModal(project) {

        document.getElementById('projectId').value = project.id;
        document.getElementById('projectName').value = project.name;
        document.getElementById('projectType').value = project.projectType;
        document.getElementById('projectLocation').value = project.location;
        document.getElementById('projectArea').value = project.area;
        document.getElementById('projectDescription').value = project.description;

        let div = document.getElementById('editImages');
        div.innerHTML = "";

        project.images.forEach(img => {
            div.innerHTML += `
                <div class="image-box">
                    <img src="/uploads/${img.imagePath}">
                    <button
                        data-path="${img.imagePath}"
                        onclick="deleteImage(${project.id}, this.dataset.path, this)"
                    >×</button>
                </div>
            `;
        });

        document.getElementById('editModal').style.display = 'flex';
    }

    function closeModal(id) {
        document.getElementById(id).style.display = "none";
    }

    /* SAVE PROJECT */
    function saveProject() {
        let id = document.getElementById('projectId').value;
        let fd = new FormData();

        fd.append("id", id);
        fd.append("name", document.getElementById('projectName').value);
        fd.append("projectType", document.getElementById('projectType').value);
        fd.append("location", document.getElementById('projectLocation').value);
        fd.append("area", document.getElementById('projectArea').value);
        fd.append("description", document.getElementById('projectDescription').value);

        let files = document.getElementById('newImages').files;
        for (let f of files) fd.append("images", f);

        fetch(`/projects/save`, { method:"POST", body:fd })
            .then(res => res.text())
            .then(() => {
                closeModal("editModal");
                premiumSuccess("Project updated successfully!");
                setTimeout(() => location.reload(), 1500);
            });
    }

    /* DELETE PROJECT */
    function deleteProject(id) {

        Swal.fire({
            title: "Are you sure?",
            text: "This project will be deleted permanently.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#e60000",
            cancelButtonColor: "#555",
            confirmButtonText: "Yes, delete it!"
        }).then(result => {
            if (result.isConfirmed) {

                fetch(`/projects/${id}`, { method:"DELETE" })
                    .then(() => {
                        premiumDelete("Project deleted!");
                        setTimeout(() => location.reload(), 1200);
                    });
            }
        });
    }

    /* DELETE IMAGE — FINAL FIX */
   	function deleteImage(projectId, imgPath, btn) {
	    if (confirm("Delete this image?")) {
	        fetch(`/projects/${projectId}/deleteImage?path=${encodeURIComponent(imgPath)}`, { method: "DELETE" })
	            .then(res => {
	                if (res.ok) {
	                    btn.parentElement.remove();
	                }
	            });
	    }
	}
</script>

<!-- FOOTER -->
<div th:replace="fragments/footer :: site-footer"></div>

<script src="js/vendor/jquery-2.2.4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4"
        crossorigin="anonymous"></script>
<script src="js/vendor/bootstrap.min.js"></script>
<script src="js/jquery.ajaxchimp.min.js"></script>
<script src="js/parallax.min.js"></script>
<script src="js/owl.carousel.min.js"></script>
<script src="js/isotope.pkgd.min.js"></script>
<script src="js/jquery.nice-select.min.js"></script>
<script src="js/jquery.magnific-popup.min.js"></script>
<script src="js/jquery.sticky.js"></script>
<script src="js/main.js"></script>

</body>
</html>
