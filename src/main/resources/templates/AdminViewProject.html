<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Admin View Projects - Gajmor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Icons -->
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>

        body {
            margin:0;
            padding:0;
            background:#0d0d0d;
            color:white;
            font-family:"Montserrat",sans-serif;
            padding-top:120px;
        }

        /* PAGE TITLE */
        .page-title {
            text-align:center;
            font-size:32px;
            color:#ffae00;
            font-weight:700;
            margin-bottom:25px;
            animation:fadeDown .5s ease;
        }
        @keyframes fadeDown {
            from { opacity:0; transform:translateY(-20px); }
            to { opacity:1; transform:translateY(0); }
        }

        /* PROJECT GRID */
        .project-grid {
            display:grid;
            grid-template-columns:repeat(auto-fill,minmax(290px,1fr));
            gap:22px;
            padding:20px;
            width:90%;
            margin:auto;
            animation:fadeIn .6s ease;
        }
        @keyframes fadeIn {
            from { opacity:0; }
            to { opacity:1; }
        }

        /* PREMIUM GLASS CARD */
        .project-card {
            background:rgba(255,255,255,0.05);
            border:1px solid rgba(255,255,255,0.12);
            backdrop-filter:blur(8px);
            border-radius:18px;
            overflow:hidden;
            box-shadow:0 4px 20px rgba(0,0,0,0.35);
            transition:.35s ease;
            animation:fadeUp .5s ease;
        }

        @keyframes fadeUp {
            from { opacity:0; transform:translateY(20px); }
            to { opacity:1; transform:translateY(0); }
        }

        .project-card:hover {
            transform:scale(1.04);
            border-color:#ffae00;
            box-shadow:0 0 25px rgba(255,174,0,0.45);
        }

        .project-card img {
            width:100%;
            height:190px;
            object-fit:cover;
        }

        .project-title {
            text-align:center;
            padding:12px;
            font-weight:700;
            font-size:18px;
            color:white;
        }

        /* CARD BUTTONS */
        .card-actions {
            padding:12px;
            display:flex;
            justify-content:space-between;
        }

        .btn {
            border:none;
            padding:8px 14px;
            border-radius:10px;
            cursor:pointer;
            font-weight:600;
            transition:.3s ease;
            font-size:14px;
        }

        .view-btn { background:#ffae00; color:black; }
        .view-btn:hover { filter:brightness(1.1); }

        .edit-btn { background:#3498db; color:white; }
        .edit-btn:hover { background:#227cbf; }

        .delete-btn { background:#e74c3c; color:white; }
        .delete-btn:hover { background:#c0392b; }

        /* MODALS */
        .modal {
            position:fixed;
            inset:0;
            background:rgba(0,0,0,0.7);
            display:none;
            justify-content:center;
            align-items:center;
            z-index:2000;
            backdrop-filter:blur(8px);
        }

        .modal-content {
            background:#111;
            border:1px solid rgba(255,255,255,0.15);
            padding:25px;
            width:95%;
            max-width:900px;
            max-height:90vh;
            overflow-y:auto;
            border-radius:16px;
            animation:pop .4s ease;
        }

        @keyframes pop {
            from { opacity:0; transform:scale(.85); }
            to { opacity:1; transform:scale(1); }
        }

        .close-btn {
            background:#ff3b3b;
            color:white;
            border:none;
            padding:8px 16px;
            float:right;
            border-radius:8px;
            cursor:pointer;
            font-weight:600;
        }
        .close-btn:hover { background:#d40000; }

        .modal-content h2 {
            color:#ffae00;
            margin-bottom:15px;
        }

        /* IMAGE PREVIEWS */
        .image-preview {
            display:flex;
            flex-wrap:wrap;
            gap:12px;
            margin-bottom:15px;
        }

        .image-preview img {
            height:150px;
            border-radius:12px;
            transition:.3s;
        }

        .image-preview img:hover {
            transform:scale(1.05);
        }

        /* EDIT FORM */
        input, textarea {
            width:100%;
            padding:12px;
            margin-bottom:12px;
            border-radius:10px;
            border:none;
            background:#1d1d1d;
            color:white;
        }
        textarea { height:130px; resize:none; }

        label { color:#ffae00; font-weight:600; }

        /* image delete button */
        .image-box {
            position:relative;
        }

        .image-box button {
            position:absolute;
            top:8px;
            right:8px;
            background:#e74c3c;
            color:white;
            border:none;
            border-radius:50%;
            font-size:12px;
            width:25px;
            height:25px;
            cursor:pointer;
        }

        /* Spinner Overlay */
        #spinnerOverlay {
            position:fixed;
            inset:0;
            background:rgba(0,0,0,0.6);
            display:none;
            justify-content:center;
            align-items:center;
            z-index:3000;
        }

        .spinner {
            border:6px solid #333;
            border-top:6px solid #ffae00;
            border-radius:50%;
            width:65px;
            height:65px;
            animation:spin 1s linear infinite;
        }

        @keyframes spin { 100% { transform:rotate(360deg); } }

        /* SUCCESS BOX */
        #successOverlay {
            position:fixed;
            inset:0;
            background:rgba(0,0,0,0.6);
            display:none;
            justify-content:center;
            align-items:center;
            color:#fff;
            z-index:3001;
        }

        .success-box {
            background:#2ecc71;
            padding:20px 40px;
            border-radius:14px;
            font-size:22px;
            font-weight:700;
        }

    </style>
</head>

<body>

<!-- HEADER -->
<!--<div th:replace="fragments/header :: site-header"></div>-->
<!-- Start Header Area -->
<header class="default-header">
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <h1 style="color: aliceblue;">Gajmor</h1>
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
                    aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="fa fa-bars"></span>
            </button>

            <div class="collapse navbar-collapse justify-content-end align-items-center" id="navbarSupportedContent">
                <ul class="navbar-nav">
                    <li><a href="/">Home</a></li>
                    <li><a class="active" href="/aboutUs">About</a></li>
                    <li><a href="/services">Services</a></li>
                    <li class="dropdown">
                        <a class="dropdown-toggle" href="#" id="navbardrop" data-toggle="dropdown">
                            Pages
                        </a>
                        <div class="dropdown-menu">
                            <a class="dropdown-item" href="/view-pro">Projects</a>
                            <!--                            &lt;!&ndash; <a class="dropdown-item" href="elements.html">Elements</a>-->
                        </div>
                    </li>
                    <li class="dropdown">
                        <a class="dropdown-toggle" href="#" id="navbardrop" data-toggle="dropdown">
                            Blog
                        </a>
                        <div class="dropdown-menu">
                            <a class="dropdown-item" href="/viewBlogs">Blog</a>
                            <a class="dropdown-item" href="blog-single.html">Blog Details</a>
                        </div>
                    </li>
                    <li><a href="/enquiry">Contact</a></li>
                </ul>
            </div>
        </div>
    </nav>
</header>
<!-- End Header Area -->


<h1 class="page-title">Admin View Projects</h1>

<!-- PROJECT GRID -->
<div class="project-grid" id="projectGrid"></div>

<!-- VIEW MODAL -->
<div class="modal" id="viewModal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('viewModal')">Close</button>

        <h2 id="viewTitle"></h2>
        <div id="viewImages" class="image-preview"></div>

        <p><strong>Location:</strong> <span id="viewLocation"></span></p>
        <p><strong>Area:</strong> <span id="viewArea"></span></p>
        <p><strong>Description:</strong> <span id="viewDescription"></span></p>

        <button class="edit-btn" onclick="switchToEdit()">Edit This Project</button>
    </div>
</div>

<!-- SPINNER -->
<div id="spinnerOverlay">
    <div class="spinner"></div>
</div>

<!-- SUCCESS -->
<div id="successOverlay">
    <div class="success-box">âœ” Project Updated Successfully!</div>
</div>

<!-- EDIT MODAL -->
<div class="modal" id="editModal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('editModal')">Close</button>

        <h2>Edit Project</h2>

        <form id="editProjectForm">

            <input type="hidden" id="projectId">

            <label>Project Name</label>
            <input type="text" id="projectName">

            <label>Project Type</label>
            <input type="text" id="projectType">

            <label>Location</label>
            <input type="text" id="projectLocation">

            <label>Area</label>
            <input type="text" id="projectArea">

            <label>Description</label>
            <textarea id="projectDescription"></textarea>

            <label>Existing Images</label>
            <div id="editImages" class="image-preview"></div>

            <label>Add More Images</label>
            <input type="file" id="newImages" multiple>

            <button type="button" onclick="saveProject()" class="view-btn" style="width:100%; margin-top:15px;">
                Save Changes
            </button>

        </form>
    </div>
</div>

<!-- FOOTER -->
<div th:replace="fragments/footer :: site-footer"></div>

<script>

    /* LOAD PROJECTS */
    fetch('/projects/list')
        .then(res => res.json())
        .then(projects => {
            const grid = document.getElementById('projectGrid');

            projects.forEach(project => {
                let card = document.createElement('div');
                card.classList.add('project-card');

                const firstImage = project.images.length > 0
                    ? `/uploads/${project.images[0].imagePath}`
                    : 'https://via.placeholder.com/400x250?text=No+Image';

                card.innerHTML = `
                    <img src="${firstImage}">
                    <div class="project-title">${project.name}</div>
                    <div class="card-actions">
                        <button class="btn view-btn" onclick='openViewModal(${JSON.stringify(project)})'>View</button>
                        <button class="btn edit-btn" onclick='openEditModal(${JSON.stringify(project)})'>Edit</button>
                        <button class="btn delete-btn" onclick="deleteProject(${project.id})">Delete</button>
                    </div>
                `;

                grid.appendChild(card);
            });
        });

    /* OPEN VIEW MODAL */
    let currentProject = null;

    function openViewModal(project) {

        currentProject = project;

        document.getElementById('viewTitle').textContent = project.name;
        document.getElementById('viewLocation').textContent = project.location || "Not provided";
        document.getElementById('viewArea').textContent = project.area || "Not provided";
        document.getElementById('viewDescription').textContent = project.description;

        document.getElementById('viewImages').innerHTML =
            project.images.map(img => `<img src="/uploads/${img.imagePath}">`).join('');

        document.getElementById('viewModal').style.display = 'flex';
    }

    /* SWITCH TO EDIT */
    function switchToEdit() {
        closeModal('viewModal');
        openEditModal(currentProject);
    }

    /* OPEN EDIT MODAL */
    function openEditModal(project) {

        document.getElementById('projectId').value = project.id;
        document.getElementById('projectName').value = project.name;
        document.getElementById('projectType').value = project.projectType;
        document.getElementById('projectLocation').value = project.location;
        document.getElementById('projectArea').value = project.area;
        document.getElementById('projectDescription').value = project.description;

        let div = document.getElementById('editImages');
        div.innerHTML = "";

        project.images.forEach(img => {
            div.innerHTML += `
                <div class="image-box">
                    <img src="/uploads/${img.imagePath}">
                    <button onclick="deleteImage(${project.id}, '${img.imagePath}', this)">x</button>
                </div>
            `;
        });

        document.getElementById('editModal').style.display = 'flex';
    }

    /* CLOSE MODAL */
    function closeModal(id) {
        document.getElementById(id).style.display = "none";
    }

    /* SAVE PROJECT */
    function saveProject() {
        let id = document.getElementById('projectId').value;
        let fd = new FormData();

        fd.append("id", id);
        fd.append("name", document.getElementById('projectName').value);
        fd.append("projectType", document.getElementById('projectType').value);
        fd.append("location", document.getElementById('projectLocation').value);
        fd.append("area", document.getElementById('projectArea').value);
        fd.append("description", document.getElementById('projectDescription').value);

        let files = document.getElementById('newImages').files;
        for (let f of files) fd.append("images", f);

        // Show spinner
        document.getElementById("spinnerOverlay").style.display = "flex";

        fetch(`/projects/save`, { method:"POST", body:fd })
            .then(res => res.text())
            .then(() => {
                document.getElementById("spinnerOverlay").style.display = "none";
                document.getElementById("successOverlay").style.display = "flex";
                setTimeout(() => location.reload(), 1500);
            });
    }

    /* DELETE PROJECT */
    function deleteProject(id) {
        if (!confirm("Delete this project?")) return;

        fetch(`/projects/${id}`, { method:"DELETE" })
            .then(() => location.reload());
    }

    /* DELETE IMAGE */
    function deleteImage(id, path, btn) {
        if (!confirm("Delete this image?")) return;

        fetch(`/projects/${id}/deleteImage?path=${encodeURIComponent(path)}`, { method:"DELETE" })
            .then(() => btn.parentElement.remove());
    }

</script>

</body>
</html>
